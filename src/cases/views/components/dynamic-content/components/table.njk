{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "./heading.njk" import defraHeading %}

{% macro defraTable(params, renderDefraComponent) %}
  {%- set rows = params.rows or [] %}
  {%- set firstCellIsHeader = params.firstCellIsHeader or false %}

  {# Extract column headers from first row #}
  {% set tableHead = [] %}
  {% if rows.length > 0 %}
    {% for columnName, columnData in rows[0] %}
      {% set headerCell = { text: columnData.label or columnName } %}
      {% set tableHead = (tableHead.push(headerCell), tableHead) %}
    {% endfor %}
  {% endif %}

  {# Transform rows data using DEFRA component renderer #}
  {% set tableRows = [] %}
  {% for row in rows %}
    {% set tableRow = [] %}
    {% set isFirstCell = true %}
    {% for columnName, columnData in row %}
      {% set cellContent = renderDefraComponent(columnData) %}
      {%
        set tableCell = {
          html: cellContent
        }
      %}

      {# Add header styling for first cell if firstCellIsHeader is enabled #}
      {% if firstCellIsHeader and isFirstCell %}
        {% set tableCell = {
          html: cellContent,
          classes: 'govuk-table__header'
        } %}
      {% endif %}

      {% set tableRow = (tableRow.push(tableCell), tableRow) %}
      {% set isFirstCell = false %}
    {% endfor %}
    {% set tableRows = (tableRows.push(tableRow), tableRows) %}
  {% endfor %}

  {% if params.title %}
    {{ defraHeading({ text: params.title, level: 3 }) }}
  {% endif %}

  {{
    govukTable({
      head: tableHead,
      rows: tableRows
    })
  }}
{% endmacro %}
