{% from "govuk/components/tag/macro.njk" import govukTag %}
{% from "govuk/components/radios/macro.njk" import govukRadios %}
{% from "govuk/components/textarea/macro.njk" import govukTextarea %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "../task-list/macro.njk" import taskList %}
{% from "../../partials/stage-action-button-group/macro.njk" import stageActionButtonGroup %}

<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds">
    <h2
      class="govuk-heading-l govuk-!-margin-top-6"
      data-testid="stage-heading"
    >
      {{ params.stage.title }}
    </h2>
    {% for taskGrout in params.stage.taskGroups %}
      <h3 class="govuk-heading-m">{{ loop.index }}. {{ taskGrout.title }}</h3>
      {{ taskList({tasks: taskGrout.tasks}) }}
    {% endfor %}

    {% if params.stage.actions.items.length > 0 %}
      <form method="POST" action="/cases/{{ params.caseId }}/stage/outcome">
        {% set radiosItems = [] %}
        {% for item in params.stage.actions.items %}
          {% if item.conditional %}
            {# Capture the textarea HTML #}
            {% set conditionalTextarea %}
              {{ govukTextarea(item.conditional) }}
            {% endset %}
            {# Create item with conditional textarea #}
            {%
              set radioItem = {
                value: item.value,
                text: item.text,
                checked: item.checked,
                conditional: { html: conditionalTextarea }
              }
            %}
            {% set radiosItems = (radiosItems.push(radioItem), radiosItems) %}
          {% else %}
            {# Create simple item #}
            {%
              set radioItem = {
                value: item.value,
                text: item.text,
                checked: item.checked
              }
            %}
            {% set radiosItems = (radiosItems.push(radioItem), radiosItems) %}
          {% endif %}
        {% endfor %}

        {{
          govukRadios({
            idPrefix: params.stage.actions.idPrefix,
            name: params.stage.actions.name,
            errorMessage: params.stage.actions.errorMessage,
            fieldset: {
              legend: {
                text: params.stage.actions.legend,
                classes: "govuk-fieldset__legend--m"
              }
            },
            items: radiosItems
          })
        }}

        {{ govukButton({ text: "Save" }) }}
      </form>
    {% endif %}
  </div>
</div>
